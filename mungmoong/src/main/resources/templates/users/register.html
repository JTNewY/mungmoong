<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/register_layout}">
<head>
    <title>íšŒì›ê°€ì…í˜ì´ì§€</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.standalone.min.css" />
    <meta name="csrf-token" th:content="${_csrf.token}"/>
    <meta name="csrf-header-name" th:content="${_csrf.headerName}"/>
  </head>
<style>
  .invalid-feedback {
      display: none;
      color: red;
  }
  .was-validated .invalid-feedback {
      display: block;
  }
    /* ëª¨ë°”ì¼ì—ì„œ ì£¼ì†Œ ì…ë ¥ ë¶€ë¶„ì˜ ë„ˆë¹„ë¥¼ ì¡°ì • */
    #address,
    #address2 {
        width: 100%;
    }

    /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ì˜ ë„ˆë¹„ë¥¼ ì¡°ì •í•˜ê³  ì¤‘ì•™ ì •ë ¬ */
    .button-container button {
        width: 45%;
        margin: 0 auto;
    }
</style>
<body layout:fragment="content">
  <div class="container-sm reserve" style="padding: 3%; width: 50%; border-radius: 15px; margin: 0 auto; margin-top: 30px; margin-bottom: 4%; background: #fff4d5">
    <div class="input-form-backgroud row">                          
      <div class="input-form col-md-12 mx-auto">
        <h4 class="mb-3">íšŒì›ê°€ì…</h4>
        <div class="button-container">
          <button id="buttonA" class="active" onclick="showContent('A', this)">ì‚¬ìš©ì</button>
          <button id="buttonB" onclick="showContent('B', this)">ë°˜ë ¤ê²¬</button>
        </div>
        <div class="validation-form" novalidate>
          <div class="row">
            <form id="form" method="post" action="/users/register/">
              <!-- CSRF TOKEN -->
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              
              <input type="hidden" id="combinedAddress" name="combinedAddress">
              <div id="contentA">
                <div class="col-md-6 mb-3">
                  <label for="name">ì´ë¦„</label>
                  <input type="text" class="form-control" name="name" id="name" placeholder="Name" value="" required>
                  <div class="invalid-feedback">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
                <div class="mb-3">
                  <label>ì„±ë³„</label>
                  <div class="input-group">
                  <div>
                    <input type="radio" name="gender" id="male" value="1" >
                    <label for="male">ë‚¨ì &nbsp;</label>
                  </div>
                  <div>
                    <input type="radio" name="gender" id="female" value="2">
                    <label for="female">ì—¬ì</label>
                  </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="id">ì•„ì´ë””</label>
                  <div class="input-group" id="box-id">
                    <input type="text" class="form-control" name="userId" id="userId" placeholder="ID" value="" required>
                    <button class="btn btn-secondary" type="button" onclick="checkId()">ì•„ì´ë”” ì¤‘ë³µí™•ì¸</button>
                    <div class="invalid-feedback">ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                  <input type="password" class="form-control" name="password" id="password" placeholder="PW" value="" required>
                  <div class="invalid-feedback">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="passwordchk">ë¹„ë°€ë²ˆí˜¸í™•ì¸</label>
                  <div class="input-group" id="box-pw">
                    <input type="password" class="form-control" id="passwordchk" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" value="" required>
                    <button class="btn btn-secondary" type="button" onclick="checkPasswordMatch()">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</button>
                    <div class="invalid-feedback">ë¹„ë°€ë²ˆí˜¸ê°€ ë¶ˆì¼ì¹˜í•©ë‹ˆë‹¤.</div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="mail">ì´ë©”ì¼</label>
                  <div class="input-group">
                      <input type="email" class="form-control" id="mail" placeholder="you@example.com" required>
                     
                      <button class="btn btn-secondary" id="sendCode">ì¸ì¦ë²ˆí˜¸ ë³´ë‚´ê¸°</button>
                  </div>
              </div>
              <div class="col-md-6 mb-3">
                  <label for="mail-verification">ì´ë©”ì¼ ì¸ì¦</label>
                  <div class="input-group">
                      <input type="text" class="form-control" id="mail-verification" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥" >
                      <button class="btn btn-secondary" id="verifyCode">ì¸ì¦ë²ˆí˜¸ í™•ì¸</button>
                  </div>
              </div>
                <div class="mb-3">
                  <label for="phone">ì „í™”</label>
                  <input type="phone" class="form-control" name="phone" id="phone" placeholder="01012341234" required>
                  <div class="invalid-feedback">ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
                <div class="mb-3">
                  <label for="address">ì£¼ì†Œ</label>
                  <input type="text" class="form-control" name="address"id="address" placeholder="" required>
                  <div class="invalid-feedback">ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
                <div class="mb-3">
                  <label for="address2">ìƒì„¸ì£¼ì†Œ<span class="text-muted">&nbsp;(í•„ìˆ˜ ì•„ë‹˜)</span></label>
                  <input type="text" class="form-control" name="address2"id="address2" placeholder="ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.">
                </div>
                <div class="mb-3">
                  <label for="brith">ìƒë…„ì›”ì¼</label>
                  <div class="input-group input-daterange">
                    <input type="text" class="form-control" name="birth"id="birth" value="2000-01-01">
                  </div>
                </div>
                <!-- <div class="custom-control custom-checkbox" style="padding: 3% 0;">
                  <input type="checkbox" class="custom-control-input" id="aggrement" required>
                  <label class="custom-control-label" for="aggrement">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
                </div> -->
              </div>
              <div id="contentB">
                <div class="mb-3">
                  <label for="petname">ì´ë¦„</label>
                  <input type="text" class="form-control" name="petname" id="petname" placeholder="" required>
                  <div class="invalid-feedback">ë°˜ë ¤ê²¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
                <div class="mb-3">
                  <label for="pettype">ê²¬ì¢…</label>
                  <input type="text" class="form-control" name="pettype" id="pettype" placeholder="ì˜ˆì‹œ : ìš”í¬ì…”í…Œë¦¬ì–´" required>
                  <div class="invalid-feedback">ê²¬ì¢…ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
                <div class="mb-3">
                  <label for="petage">ë‚˜ì´</label>
                  <input type="text" class="form-control" name="age" id="petage" placeholder="">
                </div>
                <div class="mb-3">
                  <label>ì„±ë³„</label>
                  <div class="input-group">
                  <div>
                    <input type="radio" name="petgender" id="petmale" value="1" >
                    <label for="petmale">â™‚ &nbsp;</label>
                  </div>
                  <div>
                    <input type="radio" name="petgender" id="petfemale" value="2">
                    <label for="petfemale">â™€</label>
                  </div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label for="character">ì„±ê²©</label>
                  <input type="text" class="form-control" name="character" id="character" placeholder="ex)ìˆœë‘¥ì´ì—ìš”">
                </div>
                <div>
                  <span>ê¸°íƒ€</span>
                  <br>
                  <textarea rows="4" cols="47" style="width: 100%;"></textarea>
                </div>
             
                <div class="mb-4" style="text-align: center;padding: 3% 0;">
                    <button type="submit" class="btn btn-outline-warning">ì €ì¥</button>
                  <button type="button" class="btn btn-outline-warning">ë©”ì¸</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div>
          <img src="/img/logo.png" alt="ëŒ•ëŒ•ì´" style="width: 30%; display: block; margin-left: auto; margin-right: auto;">
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/locales/bootstrap-datepicker.ko.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // ################################# ë‹¬ë ¥ ######################################## 
  

    $(document).ready(function() {
      $("div.input-daterange input").datepicker({
        language: 'ko', // í•œêµ­ì–´ ì„¤ì •
        format: 'yyyy-mm-dd', // ë‚ ì§œ í˜•ì‹ ì„¤ì •
        autoclose: true // ë‚ ì§œ ì„ íƒ í›„ ìë™ ë‹«í˜
      });
      
      $("div.input-daterange").each(function() {
        var $inputs = $(this).find('input');
        if ($inputs.length >= 2) {
          var $from = $inputs.eq(0);
          var $to = $inputs.eq(1);
          $from.on('changeDate', function(e) {
            $to.datepicker('setStartDate', new Date(e.date.valueOf()));
          });
          $to.on('changeDate', function(e) {
            $from.datepicker('setEndDate', new Date(e.date.valueOf()));
          });
        }
      });
    });
    // ################################# íšŒì›ê°€ì… ì„ íƒ ################################
    function showContent(content, clickedButton) {
      var contentA = document.getElementById("contentA");
      var contentB = document.getElementById("contentB");
      var buttons = document.querySelectorAll('.button-container button');

      // ë‚´ìš© ìˆ¨ê¹€
      contentA.style.display = "none";
      contentB.style.display = "none";

      // ëª¨ë“  ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœ í•´ì œ
      buttons.forEach(function(button) {
        button.classList.remove('active');
      });

      // ì„ íƒí•œ ë‚´ìš© ë³´ì´ê¸°
      if (content === "A") {
        contentA.style.display = "block";
      } else if (content === "B") {
        contentB.style.display = "block";
      }

      // í´ë¦­ëœ ë²„íŠ¼ í™œì„±í™” ìƒíƒœë¡œ ì„¤ì •
      clickedButton.classList.add('active');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      showContent('A', document.getElementById('buttonA'));
    });

    // ################################# ì•„ì´ë”” ì¤‘ë³µì—¬ë¶€ í™•ì¸ ################################

    // ğŸ’ CSRF TOKEN
    const csrfToken = /*[[${_csrf.token}]]*/ 'CSRF_TOKEN_PLACEHOLDER';

    /*
        ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
    */
    async function checkId() {
        const userId = document.getElementById("userId").value;

        // null ë˜ëŠ” undefined
        if (!userId) {
            alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
            return;
        }

        try {
            // ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
            const response = await fetch(`/users/register/check/${userId}`, {
                method: 'GET',
                headers: {
                    'X-CSRF-TOKEN': csrfToken
                }
            });

            if (response.ok) {
                const result = await response.json();
                let boxId = document.getElementById('box-id');
                if (result) {
                    alert('ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.');
                    boxId.classList.remove('needs-validation');
                    boxId.classList.add('was-validated');
                    return true;
                } else {
                    alert('ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤.');
                    boxId.classList.remove('was-validated');
                    boxId.classList.add('needs-validation');
                }
                return false;
            } else {
                alert('ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            return false;
        }
    }

    // ################################# ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ######################################
    async function checkPasswordMatch() {
        var password = document.getElementById('password').value;
        var passwordchk = document.getElementById('passwordchk').value;
        var invalidFeedback = document.querySelector('#box-pw .invalid-feedback');
        let boxPw = document.getElementById('box-pw');
    
        // null ë˜ëŠ” undefined ì²´í¬
        if (!password || !passwordchk) {
            alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
    
        // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
        if (password === passwordchk) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.');
            invalidFeedback.style.display = 'none';
            boxPw.classList.remove('needs-validation');
            boxPw.classList.add('was-validated');
            return true;
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            invalidFeedback.style.display = 'block';
            boxPw.classList.remove('was-validated');
            boxPw.classList.add('needs-validation');
            return false;
        }
    }

    // ################################# ì£¼ì†Œ í•©ì¹˜ê¸° ########################################
    function combineAddress() {
        var address = document.getElementById('address').value;
        var address2 = document.getElementById('address2').value;
        document.getElementById('combinedAddress').value = address + " " + address2;
    }

    document.getElementById('form').addEventListener('submit', function(event) {
      if (!document.getElementById('aggrement').checked) {
          alert('ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì•¼ í•©ë‹ˆë‹¤.');
          event.preventDefault();
          return;
      }
  
      combineAddress();
  });
  

  //======================================ì´ë©”ì¼ ì¸ì¦ =====================================
 $(document).ready(function() {
    var csrfToken = $("meta[name='csrf-token']").attr("content");
    var csrfHeader = $("meta[name='csrf-header-name']").attr("content");

    // ëª¨ë“  AJAX ìš”ì²­ì— CSRF í† í° ì„¤ì •
    $.ajaxSetup({
        beforeSend: function(xhr) {
            xhr.setRequestHeader(csrfHeader, csrfToken);
        }
    });

    $("#sendCode").click(function() {
        $.ajax({
            url: '/users/register/sendOtp',
            type: 'POST',
            contentType: "application/json",
            data: JSON.stringify({ email: $('#mail').val() }),
            success: function(response) {
                alert("ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            },
            error: function() {
                alert("ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });

    $("#verifyCode").click(function() {
        $.ajax({
            url: '/users/register/verifyOtp',
            type: 'POST',
            contentType: "application/json",
            data: JSON.stringify({
                email: $('#mail').val(),
                code: $('#mail-verification').val()
            }),
            success: function(response) {
                alert(response.message);
            },
            error: function() {
                alert("ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });
});


  

  </script>
</body>
</html>
