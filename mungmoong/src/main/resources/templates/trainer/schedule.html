<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/trainer_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ì¼€ì¥´ ê´€ë¦¬</title>
    <style>
        a {
            text-decoration: none;
            color: black;
        }
    </style>
</head>
<body class="body" layout:fragment="content">
    <div class="container">
        <div class="inner">
            <div class="title-container">
                <h1 class="title">ìŠ¤ì¼€ì¥´ ê´€ë¦¬</h1>
            </div>
            <nav class="navbar navbar-expand-lg navbar-light">
                <div class="collapse navbar-collapse justify-content-start">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="tab-button" th:href="|/trainer/info?userId=${session.user.userId}|">í›ˆë ¨ì‚¬ ì •ë³´</a>
                        </li>
                        <li class="nav-item">
                            <a class="tab-button active" href="/trainer/schedule">ìŠ¤ì¼€ì¥´ ê´€ë¦¬</a>
                        </li>
                        <li class="nav-item">
                            <a class="tab-button" href="/trainer/deposit">ì…ê¸ˆ ë‚´ì—­ì„œ</a>
                        </li>
                        <li class="nav-item">
                            <a class="tab-button" href="/trainer/orders">ì˜ˆì•½</a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="container p-4">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
    <div id='calendar-container'>
        <div id='calendar'></div>
    </div>
<!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© modal ë¶€ë¶„ -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/trainer/schedule" method="post">
                <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">íœ´ë¬´ì¼ ì¶”ê°€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ì‚¬ìœ  : <input type="text" id="title" name="title" required /><br />
                    íœ´ë¬´ì¼ : <input type="datetime-local" id="scheduleDate" name="scheduleDate" required /><br />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var trainerNo = "[[${trainerNo}]]"; // Thymeleafë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ ë³€ìˆ˜ ì£¼ì…
        // ğŸ’ CRSF TOKEN
        var csrfToken = "[[${_csrf.token}]]"

        document.addEventListener('DOMContentLoaded', async function () {
            var calendarEl = document.getElementById('calendar');

            const response = await fetch(`/trainer/schedule/event?trainerNo=${trainerNo}`)
            const eventList = await response.json()
            console.log(eventList);

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: '700px', // calendar ë†’ì´ ì„¤ì •
                expandRows: true, // í™”ë©´ì— ë§ê²Œ ë†’ì´ ì¬ì„¤ì •
                customButtons: {
                    myCustomButton: {
                        text: "ì¼ì • ì¶”ê°€",
                        click: function () {
                            $("#exampleModal").modal("show");
                        }
                    }
                },
                headerToolbar: {
                    right: 'prev,next today',
                    center: 'title',
                    left: 'myCustomButton',
                },
                selectable: true, // ë‹¬ë ¥ ì¼ì ë“œë˜ê·¸ ì„¤ì •ê°€ëŠ¥
                nowIndicator: true, // í˜„ì¬ ì‹œê°„ ë§ˆí¬
                dayMaxEvents: true, // ì´ë²¤íŠ¸ê°€ ì˜¤ë²„ë˜ë©´ ë†’ì´ ì œí•œ (+ ëª‡ ê°œì‹ìœ¼ë¡œ í‘œí˜„)
                locale: 'ko', // í•œêµ­ì–´ ì„¤ì •
                // events: `/trainer/schedule/event?trainerNo=${trainerNo}`,
                events: eventList,
                eventDidMount: function (info) {
                    // ì´ë²¤íŠ¸ê°€ ë Œë”ë§ëœ í›„ ì‹¤í–‰ë©ë‹ˆë‹¤.
                    info.el.title = info.event.start; // ì´ë²¤íŠ¸ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ í‘œì‹œí•  íˆ´íŒ ì„¤ì •
                    info.el.style.backgroundColor = '#FFD700'
                },
                eventClick: function(info) {
                    console.dir(info);
                    console.dir(info.event._def.extendedProps);     
                    console.log(info.event._def.extendedProps.no);      // ìŠ¤ì¼€ì¥´ ë²ˆí˜¸

                    let no = info.event._def.extendedProps.no
                    // ìŠ¤ì¼€ì¥´ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ STOP
                    if( !no ) {
                        Swal.fire({
                            title: "ìŠ¤ì¼€ì¥´ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.",
                            text: "ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.",
                            icon: "error"
                        });
                        return
                    }

                    Swal.fire({
                        title: "ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                        text: "ì‚­ì œëœ ì¼ì •ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "ì‚­ì œ",
                        cancelButtonText: "ì·¨ì†Œ"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // [DELETE ìš”ì²­]
                            fetch(`/trainer/schedule/event/${no}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-Token': csrfToken // CSRF í† í° ì¶”ê°€
                                }
                            }).then(response => {
                                if (response.ok) {
                                    info.event.remove(); 
                                    // alert("ì´ë²¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                                    Swal.fire({
                                        title: "ì¼ì • ì‚­ì œ",
                                        text: "ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.",
                                        icon: "success"
                                    });
                                } else {
                                    //alert("ì´ë²¤íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                                    Swal.fire({
                                        title: "ì¼ì • ì‚­ì œ ì‹¤íŒ¨",
                                        text: "ì¼ì • ì‚­ì œê°€ ì‹¤íŒ¨ë˜ì—ˆìŠµë‹ˆë‹¤.",
                                        icon: "error"
                                    });
                                }
                            }).catch(error => {
                                console.error('Error:', error);
                                // alert("ì´ë²¤íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                                Swal.fire({
                                    title: "ì¼ì • ì‚­ì œ ì¤‘ ì—ëŸ¬",
                                    text: "ì¼ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
                                    icon: "error"
                                });
                            });

                            
                            
                        }
                    });


                }
            });
            calendar.render();
        });

        $("#saveChanges").on("click", function () {
            var eventData = {
                title: $("#title").val(),
                scheduleDate: $("#scheduleDate").val(),
                trainerNo: trainerNo
            };

            if (eventData.title === "" || eventData.scheduleDate === "") {
                alert("ì…ë ¥í•˜ì§€ ì•Šì€ ê°’ì´ ìˆìŠµë‹ˆë‹¤.");
            } else {
                // ì„œë²„ì— ì´ë²¤íŠ¸ ì €ì¥
                $.ajax({
                    url: '/trainer/schedule',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(eventData),
                    success: function (response) {
                        alert("ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        // ì´ë²¤íŠ¸ ì¶”ê°€
                        calendar.addEvent({
                            title: eventData.title,
                            start: eventData.scheduleDate
                        });
                        $("#exampleModal").modal("hide");
                        $("#title").val("");
                        $("#scheduleDate").val("");
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error('Error saving event:', textStatus, errorThrown);
                        alert("ì¼ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            }
        });
    </script>
</body>
</html>
