<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/trainer_layout}">
    <!-- â­ layout:decorate="~{/ë ˆì´ì•„ì›ƒ ê²½ë¡œ/ë ˆì´ì•„ì›ƒ íŒŒì¼ëª…}" -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ì¼€ì¥´ ê´€ë¦¬</title>
    <!-- â­ layout:fragment="ë ˆì´ì•„ì›ƒ í”„ë ˆê·¸ë¨¼íŠ¸ ì´ë¦„" -->
</head>
<body class="body" layout:fragment="content">
    <div class="container">
        <div class="inner">
            <div class="title-container">
                <h1 class="title">ìŠ¤ì¼€ì¥´ ê´€ë¦¬</h1>
            </div>
            <nav class="navbar navbar-expand-lg navbar-light">
                <div class="collapse navbar-collapse justify-content-start">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="tab-button" th:href="|/trainer/info?userId=${session.user.userId}|">í›ˆë ¨ì‚¬ ì •ë³´</a>
                        </li>
                        <li class="nav-item">
                            <a class="tab-button active" href="/trainer/schedule">ìŠ¤ì¼€ì¥´ ê´€ë¦¬</a>
                        </li>
                         
                        <li class="nav-item">
                            <a class="tab-button" href="/trainer/deposit">ì…ê¸ˆ ë‚´ì—­ì„œ</a>
                        </li>
                        <li class="nav-item">
                            <a class="tab-button" href="/trainer/orders">ì˜ˆì•½</a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="calendar-container">
                <div class="calendar">
                    <div class="header">
                        <button id="prev-month">â®</button>
                        <span id="month-year"></span>
                        <button id="next-month">â¯</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ì¼</th>
                                <th>ì›”</th>
                                <th>í™”</th>
                                <th>ìˆ˜</th>
                                <th>ëª©</th>
                                <th>ê¸ˆ</th>
                                <th>í† </th>
                            </tr>
                        </thead>
                        <tbody id="calendar-body">
                            <!-- Calendar dates will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="div_msg">
                <p class="msg">íœ´ë¬´ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            </div>
            <div class="text-end">
                <button type="button" class="btn-custom2" id="save-dates">ì €ì¥</button>
            </div>
        </div>
    </div>
    <script>
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        let currentYear = year;
        let currentMonth = month; 

        let clickedDateList = new Array();

        const monthNames = [
            "1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”",
            "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"
        ];

        const holidays = {
            "1-1": "ì‹ ì •",
            "3-1": "ì‚¼ì¼ì ˆ",
            "5-5": "ì–´ë¦°ì´ë‚ ",
            "6-6": "í˜„ì¶©ì¼",
            "8-15": "ê´‘ë³µì ˆ",
            "10-3": "ê°œì²œì ˆ",
            "10-9": "í•œê¸€ë‚ ",
            "12-25": "ì„±íƒ„ì ˆ"
        };

        document.getElementById('prev-month').addEventListener('click', () => {
            changeMonth(-1);
        });

        document.getElementById('next-month').addEventListener('click', () => {
            changeMonth(1);
        });

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        function updateCalendar() {
            const calendarBody = document.getElementById('calendar-body');
            calendarBody.innerHTML = '';
            document.getElementById('month-year').innerText = `${currentYear}ë…„ ${monthNames[currentMonth]}`;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            let date = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');

                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if (i === 0 && j < firstDay) {
                        cell.innerHTML = '';
                    } else if (date > daysInMonth) {
                        break;
                    } else {
                        const dateKey = `${currentMonth + 1}-${date}`;
                        cell.innerHTML = date;
                        cell.classList.add('clickable');
                        if (holidays[dateKey]) {
                            cell.classList.add('holiday');
                        }
                        cell.addEventListener('click', () => {
                            // let clickedDay = cell.textContent;
                            // let clickedDate = `${currentYear}-${currentMonth + 1}-${clickedDay}`;

                            // if (cell.classList.contains('clicked')) {
                            //     cell.classList.remove('clicked');
                            //     const index = clickedDateList.indexOf(clickedDate);
                            //     if (index !== -1) {
                            //         clickedDateList.splice(index, 1);
                            //     }
                            // } else {
                            //     cell.classList.add('clicked');
                            //     clickedDateList.push(clickedDate);
                            // }
                        });
                        date++;
                    }
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
            }
        }

        document.getElementById('save-dates').addEventListener('click', () => {
            let csrfToken = "[[${_csrf.token}]]";
            let url = "/trainer/schedule";         // ìš”ì²­ ê²½ë¡œ      //   /replys
            
            $.ajax({
                type: 'POST',                                       // ìš”ì²­ ë©”ì†Œë“œ - GET, POST, PUT, DELETE
                url: url,                                           // ìš”ì²­ URL
                data: JSON.stringify({ dates: clickedDateList }),   // ìš”ì²­ ë°ì´í„°
                contentType: 'application/json',                    // ìš”ì²­ ë°ì´í„° íƒ€ì…
                dataType: 'html',                                   // ì‘ë‹µ ë°ì´í„° íƒ€ì…
                beforeSend: function(xhr) {
                    // ğŸ’ CSRF í† í°ì„ ìš”ì²­ í—¤ë”ì— ì¶”ê°€
                    xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
                },
                // ìš”ì²­ ì„±ê³µ 
                success: function(response, status) {
                    // response : ì‘ë‹µ ë°ì´í„°
                    // status   : ì‘ë‹µ ìƒíƒœ
                    let result = JSON.parse(response);
                    // ì¶”ê°€ ì‘ì—…...
                    alert('ë‚ ì§œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                // ì—ëŸ¬
                error: function(xhr, status) {
                    // xhr      : XMLHttpRequest ê°ì²´
                    // status   : ì‘ë‹µ ìƒíƒœ
                    alert('ì—ëŸ¬ ë°œìƒ');
                }
            });
        });

        updateCalendar();

        document.addEventListener("DOMContentLoaded", function() {
            let $dateButtons = document.getElementsByClassName('clickable');

            for (let i = 0; i < $dateButtons.length; i++) {
                const btn = $dateButtons[i];
                // ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸
                btn.addEventListener('click', () => {
                    let clickedDay = btn.textContent;
                    let month = currentMonth + 1;
                    let day = parseInt(clickedDay);

                    // ì›”ê³¼ ì¼ì„ ë‘ ìë¦¬ ìˆ«ìë¡œ ë³€í™˜
                    let formattedMonth = month < 10 ? '0' + month : month;
                    let formattedDay = day < 10 ? '0' + day : day;

                    let clickedDate = `${currentYear}-${formattedMonth}-${formattedDay}`;

                    if( btn.classList.contains('clicked') ) {
                        btn.classList.remove('clicked');
                        // ì„ íƒí•œ ë‚ ì§œ ë°°ì—´ì—ì„œ ì œê±°
                        const index = clickedDateList.indexOf(clickedDate);
                        if (index !== -1) {
                            clickedDateList.splice(index, 1);
                        }
                    } else {
                        btn.classList.add('clicked');
                        // ì„ íƒí•œ ë‚ ì§œ ë°°ì—´ì— ì¶”ê°€
                        clickedDateList.push(clickedDate);
                    }
                    alert(clickedDateList);
                });
            }
        });
    </script>
</body>
</html>